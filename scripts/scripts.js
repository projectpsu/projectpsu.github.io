$.event.special.tap.emitTapOnTaphold=false;var allpositions=['QB','RB','WR','TE','OT','OG / OC','DE','DT','LB','CB','S','K','P','LS'];var iFirstClass=$('div.cell.yr:first').index();var iFirstPos=$('div.cell.pos-head:first').parent().index();var NUM_CLASSES=$('div.cell.yr').length;var NUM_POSITIONS=$('div.cell.pos-head').length;var NUM_HEADERS=$('div.row.headers').length;var iLastClass=NUM_CLASSES-iFirstClass+1;var iLastPosition=NUM_POSITIONS+NUM_HEADERS-iFirstPos+1;fullRecalculate();calcTargetTotal(false);$('#AdvanceSeason').click(function(){advanceSeason()});$('#AddRecruits').click(function(){addRecruits()});$('#Filter').click(function(){clickFilter()});$('#FileManagement').click(function(){clickFileManagement()});$('#StartOver').click(function(){clickStartOver()});$('#Help').click(function(){clickHelp()});$('.help-header').click(function(){clickHelpHeader(this)});initiateFilterListeners();initiateFileListeners();var $players=$('div.player:not(.example, .add-player)');var pgroups='div.players';var $playergroups=$(pgroups);initiateChangeListeners();$('div.add-player').click(function(){addPlayerName(this)});$('div.position span.target-value').click(function(){clickTargetValue(this)});$(document).mousedown(function(event){var $elem=$(event.target);if($('#moving').length>0){if(!isValidDropTarget(event.target)){$('#moving').removeAttr('id')}}});var valueHeadSticky=new Waypoint.Sticky({element:$('div.row.headers')[1],stuckClass:'fixed',handler:function(){var ht=$('div.row.headers:first-child').outerHeight(true);$('div.row.headers.yr-totals.fixed').css('top',ht+'px')},direction:'down',offset:$('div.row.headers:first-child').outerHeight(true)});var topHeadSticky=new Waypoint.Sticky({element:$('div.row.headers')[0],stuckClass:'fixed',direction:'down'});var source;function clickFilter(){var $btn=$('#Filter');turnOffSubMenus($btn.get(0));var on=$btn.attr('on');if(on){$btn.removeAttr('on');$('#filter-menu').css('display','none')}else{$btn.attr('on','true');$('#filter-menu').css('display','block')}resetStickies()}function clickFileManagement(){var $btn=$('#FileManagement');turnOffSubMenus($btn.get(0));var on=$btn.attr('on');if(on){$btn.removeAttr('on');$('#file-menu').css('display','none')}else{$btn.attr('on','true');$('#file-menu').css('display','block')}resetStickies()}function clickStartOver(){location.reload()}function clickHelp(){var $helpbtn=$('#Help');var $helpblock=$('#helpblock');turnOffSubMenus($helpbtn.get(0));var helpon=$helpbtn.attr('on');if(helpon){$helpbtn.removeAttr('on');$helpblock.css('display','none')}else{$helpbtn.attr('on','true');$helpblock.css('display','block')}resetStickies()}function clickHelpHeader(btn){if($(btn).attr('on')){$(btn).removeAttr('on');$(btn).siblings('.help-content').css('display','none')}else{$(btn).attr('on','true');$(btn).siblings('.help-content').css('display','block')}resetStickies()}function turnOffSubMenus(btn){var selection='ul.main-menu > li.sub:not(#'+$(btn).attr('id')+')';$(selection).each(function(){if($(this).attr('on')){$(this).click()}})}function resetStickies(){valueHeadSticky.destroy();topHeadSticky.destroy();valueHeadSticky=new Waypoint.Sticky({element:$('div.row.headers')[1],stuckClass:'fixed',handler:function(){var ht=$('div.row.headers:first-child').outerHeight(true);$('div.row.headers.yr-totals.fixed').css('top',ht+'px')},direction:'down',offset:$('div.row.headers:first-child').outerHeight(true)});topHeadSticky=new Waypoint.Sticky({element:$('div.row.headers')[0],stuckClass:'fixed',direction:'down'})}function addRecruits(){var addPlyrOn=$('#AddRecruits').attr('on');if(addPlyrOn){$('#AddRecruits').removeAttr('on');$('div.player.add-player').css('display','none')}else{$('#AddRecruits').attr('on','true');$('div.player.add-player').css('display','inline-block')}}function addPlayerName(target){var originaltext=$(target).text();$(target).html(getPlayerInput());var $in=$(target).find('input');$in.select();$in.keydown(function(event){if(event.keyCode==13){createPlayerFromInput(this)}if(event.keyCode==27){$in.prop("selected","false");$(target).text(originaltext)}});$in.blur(function(){createPlayerFromInput(this)});function createPlayerFromInput(inpt){var value=$in.val();$in.prop("selected","false");var e=getPlayerElement();if(value===''){value='Player Name'}var fullp=value+getShirtImageElement();var $test=$(e).html(fullp);var $par=$(target).closest('div.players');$par.append($test.get(0));$(target).text(originaltext);calcPlayersColumn($par.index());initiatePlayerChangeListeners($test.get(0));reorderAddPlayer(target)}}function getPlayerElement(){var elem='<div class="player" draggable="true"></div>';return elem}function getShirtImageElement(){return ' <div class="rs-img"><img src="./img/blackshirt_transparent.png">'}function getPlayerInput(){var elem='<input type="text" placeholder="Player Name"></input>';return elem}function initiateChangeListeners(){$players.each(function(){var elem=$(this).get(0);initiatePlayerChangeListeners(elem)});$playergroups.each(function(){$(this).tap(function(event){if($('#moving').length>0){this.style.backgroundColor="darkgray";mobileDrop(event,$(this));this.style.backgroundColor=""}});this.ondragover=function(event){dragOver(event)};this.ondragleave=function(event){dragLeave(event)};this.ondrop=function(event){drop(event)}})}function initiatePlayerChangeListeners(elem){$plyr=$(elem);var plyrheld=false;$plyr.attr('draggable','true');$plyr.on('taphold',function(event){plyrheld=true;mobileDrag(event)});$plyr.click(function(event){if(!plyrheld){if($('#moving').length>0){mobileDrop(event,$(this).closest(pgroups))}else{clickPlayer($(this))}}else{plyrheld=false}});elem.ondragstart=function(event){dragStart(event)};elem.ondragover=function(event){dragOver(event)};elem.ondragleave=function(event){dragLeave(event)};elem.ondrop=function(event){drop(event)}}function clickPlayer($plyr){var rs=$plyr.attr('rs');var lvg=$plyr.attr('leaving');var usedrs=$plyr.attr('used-rs');if($plyr.closest(pgroups).hasClass('incoming')){var gs=$plyr.attr('gs');if(lvg){$plyr.removeAttr('leaving');$plyr.attr('gs','true')}else if(gs){$plyr.removeAttr('gs')}else{$plyr.attr('leaving','true')}}else if(usedrs){if(lvg){$plyr.removeAttr('leaving')}else{$plyr.attr('leaving','true')}}else{if(lvg){$plyr.removeAttr('leaving')}else if(rs){$plyr.removeAttr('rs');$plyr.attr('leaving','true')}else{$plyr.attr('rs','true')}}}function initiateFilterListeners(){$('#Filter-Offense').click(function(){var selection='div.position.defense, div.position.sts';filter(this,selection,'table',true)});$('#Filter-Defense').click(function(){var selection='div.position.offense, div.position.sts';filter(this,selection,'table',true)});$('#Filter-STs').click(function(){var selection='div.position.offense, div.position.defense';filter(this,selection,'table',true)});$('#Filter-RS').click(function(){var selection='div.player:not(.example, .add-player, [rs])';filter(this,selection,'inline-block',false)});$('#Filter-RSAvailable').click(function(){var selection='div.player[used-rs]:not(.example, .add-player), div.incoming > div.player:not(.add-player)';filter(this,selection,'inline-block',false)});$('#Filter-UsedRS').click(function(){var selection='div.player:not(.example, .add-player, [used-rs])';filter(this,selection,'inline-block',false)});$('#Filter-Leaving').click(function(){var selection='div.player:not(.example, .add-player, [leaving])';filter(this,selection,'inline-block',false)});$('#Filter-Off').click(function(){filterTurnAllOff(this);fullRecalculate();calcTargetTotal(false)})}function filter(btn,selection,disp,trgtcalc){filterTurnAllOff(btn);if($(btn).attr('on')){$(selection).css('display',disp);$(btn).removeAttr('on')}else{$(selection).css('display','none');$(btn).attr('on','true')}fullRecalculate();calcTargetTotal(trgtcalc)}function filterTurnAllOff(btn){var filtertext='ul#filter-menu > li:not(#'+$(btn).attr('id')+')';$(filtertext).removeAttr('on');$('div.player:not(.example, .add-player)').css('display','inline-block');$('div.row.position').css('display','table')}function initiateFileListeners(){$('#CreateFile').click(function(){createFile()});$('#upload').change(function(){loadFile(this)})}var linkToFile='';function createFile(){var pjson={};pjson['year']=$('#CurrentSeasonValue').text();$('div.row.position').each(function(){var $row=$(this);var $plyrs=$row.find('div.player:not(.add-player)');var pos=$row.find('div.pos-head').text();var posjson={};var plyrarray=[];var trgt=$row.find('span.inner-cell.target-value').text();posjson['Target']=trgt;$plyrs.each(function(){var $plyr=$(this);var name=$plyr.text();var rs=$plyr.attr('rs')?true:false;var usedrs=$plyr.attr('used-rs')?true:false;var leaving=$plyr.attr('leaving')?true:false;var col=$plyr.closest(pgroups).index();var jp={Name:name,RS:rs,UsedRS:usedrs,Leaving:leaving,Col:col};plyrarray.push(jp)});posjson['Players']=plyrarray;pjson[pos]=posjson});var s=JSON.stringify(pjson);linkToFile=makeTextFile(s);$('#DownloadFileLink').attr('href',linkToFile);$('#DownloadFile').css('display','inline-block')}function getYrsEligibleFromIndex(index){return 5-index+iFirstClass}var textFile=null;function makeTextFile(text){var data=new Blob([text],{type:'text/plain'});if(textFile!==null){window.URL.revokeObjectURL(textFile)}textFile=window.URL.createObjectURL(data);return textFile};function loadFile(btn){var file=btn.files[0];var reader=new FileReader();reader.onloadend=function(e){if(e.target.readyState==FileReader.DONE){var filetext=reader.result;var allplayers=JSON.parse(filetext);$('#CurrentSeasonValue').text(allplayers['year']);setAllPlayers(allplayers)}};reader.readAsText(file)}function reorderAddPlayers(){$('div.add-player').each(function(){reorderAddPlayer(this)})}function reorderAddPlayer(elem){var $cell=$(elem).closest(pgroups);$cell.append($(elem))}function setAllPlayers(allplayers){$('div.player:not(.add-player, .example)').remove();for(var pos in allplayers){if(allplayers.hasOwnProperty(pos)){var rowindex=allpositions.indexOf(pos);if(rowindex==-1){continue}var $row=$('div.row.position').eq(rowindex);var trgt=allplayers[pos]['Target'];$row.find('span.inner-cell.target-value').text(trgt);var curplayers=allplayers[pos]['Players'];for(var i=0,len=curplayers.length;i<len;i+=1){var p=curplayers[i];var $cell=$row.find('div.cell:eq('+p.Col+')');var e=getPlayerElement();var $plyr=$(e).html(p.Name+getShirtImageElement());p.RS?$plyr.attr('rs','true'):'';p.UsedRS?$plyr.attr('used-rs','true'):'';p.Leaving?$plyr.attr('leaving','true'):'';$cell.append($plyr);initiatePlayerChangeListeners($plyr.get(0))}}}reorderAddPlayers();fullRecalculate();calcTargetTotal(false)}function dragStart(e){source=e.target;$(source).attr('id','moving');if($(source).closest(pgroups).hasClass('incoming')||$(source).data('original-yr')){$(source).data('original-yr','incoming');e.dataTransfer.setData("incoming",'true')}e.dataTransfer.setData("text",e.target.id);e.dataTransfer.setData("col",$(e.target).closest(pgroups).index());e.dataTransfer.setData("row",$(e.target).closest('div.row').index());e.dataTransfer.effectAllowed="move"}function dragLeave(e){$(e.target).closest(pgroups).get(0).style.backgroundColor=""}function dragOver(e){e.preventDefault();if($(e.target).closest(pgroups).hasClass('incoming')){if(e.dataTransfer.getData("col")==iFirstClass||e.dataTransfer.getData('incoming')=='true'){$(e.target).closest(pgroups).get(0).style.backgroundColor="darkgray";e.dataTransfer.dropEffect="move"}}else{$(e.target).closest(pgroups).get(0).style.backgroundColor="darkgray";e.dataTransfer.dropEffect="move"}}function drop(e){e.preventDefault();e.stopPropagation();var elemId=e.dataTransfer.getData("text");var sourceCol=e.dataTransfer.getData("col");var sourceRowIndex=e.dataTransfer.getData("row");var target=$(e.target).closest(pgroups).get(0);var elem=document.getElementById(elemId);target.style.backgroundColor="";$(elem).removeAttr('id');if($(target).hasClass('incoming')&&(sourceCol!=iFirstClass&&!$(elem).data('original-yr'))){return}target.appendChild(elem);if($(target).hasClass('incoming')){var addp=$(target).find('.add-player');$(target).append(addp)}var targetCol=$(target).closest('div.cell').index();var targetRow=$(target).closest('div.row').get(0);if(e.dataTransfer.getData('incoming')&&targetCol!=iFirstClass){$(elem).data('original-yr','incoming')}var sourceRow=$('div.row').get(sourceRowIndex);calcPlayersRow(sourceRow);calcPlayersRow(targetRow);if(sourceCol!=targetCol){calcPlayersColumn(sourceCol);calcPlayersColumn(targetCol)}}var movingprops={};function mobileDrag(e){source=e.target;$(source).attr('id','moving');if($(source).closest(pgroups).hasClass('incoming')||$(source).data('original-yr')){$(source).data('original-yr','incoming');movingprops['incoming']=true}else{movingprops['incoming']=false}movingprops['col']=$(e.target).closest(pgroups).index();movingprops['row']=$(e.target).closest('div.row').index()}function mobileDrop(e,$par){e.stopPropagation();var elemId='moving';var sourceCol=movingprops['col'];var sourceRowIndex=movingprops['row'];var target=$par.get(0);var elem=$('#'+elemId).get(0);target.style.backgroundColor="";$(elem).removeAttr('id');if($(target).hasClass('incoming')&&(sourceCol!=iFirstClass&&!$(elem).data('original-yr'))){return}target.appendChild(elem);if($(target).hasClass('incoming')){var addp=$(target).find('.add-player');$(target).append(addp)}var targetCol=$(target).closest('div.cell').index();var targetRow=$(target).closest('div.row').get(0);if(movingprops['incoming']&&targetCol!=iFirstClass){$(elem).data('original-yr','incoming')}var sourceRow=$('div.row').get(sourceRowIndex);calcPlayersRow(sourceRow);calcPlayersRow(targetRow);if(sourceCol!=targetCol){calcPlayersColumn(sourceCol);calcPlayersColumn(targetCol)}}function isValidDropTarget(droptrgt){if($(droptrgt).hasClass('cell')&&$(droptrgt).hasClass('players')){return true}else{return false}}function advanceSeason(){var $players=$(pgroups);$players.each(function(){var $curplyrs=$(this);var clss=$curplyrs.attr('class');if($curplyrs.index()==iLastClass){var $p=$curplyrs.find('div.player:not([advanced])');$p.each(function(){var $plyr=$(this);if(!$plyr.attr('rs')||$plyr.attr('leaving')){$plyr.remove()}else if($plyr.attr('rs')){$plyr.removeAttr('rs');$plyr.attr('used-rs','true')}})}else{var $p=$curplyrs.find('div.player:not([advanced])');$p.each(function(){var $plyr=$(this);if($plyr.attr('leaving')){$plyr.remove();return}if($plyr.hasClass('add-player')){return}if(!$curplyrs.hasClass('incoming')&&$plyr.attr('rs')){$plyr.attr('used-rs','true');$plyr.removeAttr('rs')}else{if($curplyrs.hasClass('incoming')){if($plyr.attr('gs')){$plyr.removeAttr('gs');return}$plyr.attr('rs','true')}$plyr.attr('advanced','true');$curplyrs.next().append($plyr)}})}});$advPlayers=$('div.player[advanced]');$advPlayers.removeAttr('advanced');fullRecalculate();addOneToCurrentSeason()}function addOneToCurrentSeason(){var $value=$('#CurrentSeasonValue');$value.text(parseInt($value.text())+1)}function fullRecalculate(){calcAllPlayersColumns();calcAllPlayersRows();calcValuesColumn()}function calcAllPlayersColumns(){for(var i=iFirstClass;i<=iLastClass;i+=1){calcPlayersColumn(i)}}function calcAllPlayersRows(){$('div.row.position').each(function(){calcPlayersRow(this)})}function calcPlayersColumn(index){var count=$('div.row.position').find('div.cell:eq('+index+') > div.player:not(.add-player):visible').length;$('div.row.yr-totals').find('div.cell:eq('+index+')').text(count.toString())}function calcValuesColumn(){$('div.total-value.final span.total-value').text($('div.players:not(.incoming) > div.player:visible').length.toString())}function calcPlayersRow(row){var count=$(row).find('div.players:not(.incoming) > div.player:visible').length;$(row).find('span.total-value').text(count.toString())}function calcTargetTotal(visible){var count=0;var s='';if(visible){s='div.row.position span.inner-cell.target-value:visible'}else{s='div.row.position span.inner-cell.target-value'}$(s).each(function(){count+=parseInt($(this).text())});$('div.row.headers div.cell.total-value span.target-value').text(count)}function clickTargetValue(trgt){var on=$(trgt).attr('on');if(!on){var curval=parseInt($(trgt).text());var inpt=getTargetInput(curval);$(trgt).html(inpt);var $in=$(trgt).find('input');$in.focus();$in.select();$(trgt).attr('on','true');$in.keydown(function(){if(event.keyCode==13){setTargetValue()}if(event.keyCode==27){cancelSetTargetValue()}});$in.blur(function(){setTargetValue()});function setTargetValue(){$(trgt).text($in.val());$(trgt).removeAttr('on');calcTargetTotal(true)}function cancelSetTargetValue(){$(trgt).text(curval);$(trgt).removeAttr('on')}}}function getTargetInput(init){var elem='<input type="number" max="20" min="0" step="1" value="'+init+'"></input>';return elem}
